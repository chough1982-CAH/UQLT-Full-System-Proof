"""
run_collapse_engine.py

Executes helium-dominance-driven collapse and core formation.

This script assumes the stage-chain has already produced
helium-family states. It then enforces:

- local helium dominance detection
- mandatory collapse when threshold is exceeded
- formation of stable CORE states

Failure to collapse when conditions are met halts execution.
"""

import numpy as np

from engine.grid import Grid
from engine.states import State
from engine.transitions import apply_transitions
from engine.collapse import enforce_collapse
from config.constants import ENERGY_INTAKE
from config.parameters import (
    STEPS_COLLAPSE,
    RANDOM_SEED,
    MIN_STEPS_BEFORE_COLLAPSE_CHECK,
)

np.random.seed(RANDOM_SEED)


def run_collapse_engine():
    grid = Grid()

    # Seed initial helium at center to represent prior stage-chain completion
    c = grid.center
    grid.set_state(c, c, State.HELIUM)

    for step in range(STEPS_COLLAPSE):
        # Energy intake and state transitions
        for i, j in grid.iter_cells():
            state = grid.get_state(i, j)

            if state == State.VOID or state == State.CORE:
                continue

            delta = ENERGY_INTAKE.get(state.name, 0.0)
            if delta > 0.0:
                grid.add_energy(i, j, delta)

            new_state = apply_transitions(state, grid.get_energy(i, j))
            if new_state != state:
                grid.set_state(i, j, new_state)

        # Enforce collapse only after minimum steps
        if step >= MIN_STEPS_BEFORE_COLLAPSE_CHECK:
            collapse_count = enforce_collapse(grid)

            # Optional: log collapse events
            if collapse_count > 0:
                pass

    return grid


if __name__ == "__main__":
    run_collapse_engine()
